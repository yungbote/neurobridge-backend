{
  "type": "object",
  "properties": {
    "schema_version": { "type": "integer", "const": 1 },
    "title": { "type": "string" },
    "summary": { "type": "string" },
    "concept_keys": { "type": "array", "items": { "type": "string" } },
    "estimated_minutes": { "type": "integer" },

    "order": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "kind": {
            "type": "string",
            "enum": [
              "heading",
              "paragraph",
              "callout",
              "code",
              "figure",
              "video",
              "diagram",
              "table",
              "equation",
              "quick_check",
              "flashcard",
              "divider",
              "objectives",
              "prerequisites",
              "key_takeaways",
              "glossary",
              "common_mistakes",
              "misconceptions",
              "edge_cases",
              "heuristics",
              "steps",
              "checklist",
              "faq",
              "intuition",
              "mental_model",
              "why_it_matters",
              "connections"
            ]
          },
          "id": { "type": "string" }
        },
        "required": ["kind", "id"],
        "additionalProperties": false
      }
    },

    "headings": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "level": { "type": "integer", "enum": [2, 3, 4] },
          "text": { "type": "string" }
        },
        "required": ["id", "level", "text"],
        "additionalProperties": false
      }
    },

    "paragraphs": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "md": { "type": "string" },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "md", "citations"],
        "additionalProperties": false
      }
    },

    "callouts": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "variant": { "type": "string", "enum": ["info", "tip", "warning"] },
          "title": { "type": "string" },
          "md": { "type": "string" },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "variant", "title", "md", "citations"],
        "additionalProperties": false
      }
    },

    "codes": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "language": { "type": "string" },
          "filename": { "type": "string" },
          "code": { "type": "string" }
        },
        "required": ["id", "language", "filename", "code"],
        "additionalProperties": false
      }
    },

    "figures": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "asset": {
            "type": "object",
            "properties": {
              "url": { "type": "string" },
              "material_file_id": { "type": "string" },
              "storage_key": { "type": "string" },
              "mime_type": { "type": "string" },
              "file_name": { "type": "string" },
              "source": { "type": "string", "enum": ["upload", "derived", "external", ""] }
            },
            "required": ["url", "material_file_id", "storage_key", "mime_type", "file_name", "source"],
            "additionalProperties": false
          },
          "caption": { "type": "string" },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "asset", "caption", "citations"],
        "additionalProperties": false
      }
    },

    "videos": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "url": { "type": "string" },
          "start_sec": { "type": "number" },
          "caption": { "type": "string" }
        },
        "required": ["id", "url", "start_sec", "caption"],
        "additionalProperties": false
      }
    },

    "diagrams": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "kind": { "type": "string", "enum": ["svg", "mermaid"] },
          "source": { "type": "string" },
          "caption": { "type": "string" },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "kind", "source", "caption", "citations"],
        "additionalProperties": false
      }
    },

    "tables": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "caption": { "type": "string" },
          "columns": { "type": "array", "items": { "type": "string" } },
          "rows": { "type": "array", "items": { "type": "array", "items": { "type": "string" } } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "caption", "columns", "rows", "citations"],
        "additionalProperties": false
      }
    },

    "equations": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "latex": { "type": "string" },
          "display": { "type": "boolean" },
          "caption": { "type": "string" },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "latex", "display", "caption", "citations"],
        "additionalProperties": false
      }
    },

    "objectives": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "items_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "items_md", "citations"],
        "additionalProperties": false
      }
    },

    "prerequisites": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "items_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "items_md", "citations"],
        "additionalProperties": false
      }
    },

    "key_takeaways": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "items_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "items_md", "citations"],
        "additionalProperties": false
      }
    },

    "glossary": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "terms": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "term": { "type": "string" },
                "definition_md": { "type": "string" }
              },
              "required": ["term", "definition_md"],
              "additionalProperties": false
            }
          },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "terms", "citations"],
        "additionalProperties": false
      }
    },

    "common_mistakes": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "items_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "items_md", "citations"],
        "additionalProperties": false
      }
    },

    "misconceptions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "items_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "items_md", "citations"],
        "additionalProperties": false
      }
    },

    "edge_cases": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "items_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "items_md", "citations"],
        "additionalProperties": false
      }
    },

    "heuristics": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "items_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "items_md", "citations"],
        "additionalProperties": false
      }
    },

    "steps": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "steps_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "steps_md", "citations"],
        "additionalProperties": false
      }
    },

    "checklist": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "items_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "items_md", "citations"],
        "additionalProperties": false
      }
    },

    "faq": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "qas": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "question_md": { "type": "string" },
                "answer_md": { "type": "string" }
              },
              "required": ["question_md", "answer_md"],
              "additionalProperties": false
            }
          },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "qas", "citations"],
        "additionalProperties": false
      }
    },

    "intuition": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "md": { "type": "string" },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "md", "citations"],
        "additionalProperties": false
      }
    },

    "mental_model": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "md": { "type": "string" },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "md", "citations"],
        "additionalProperties": false
      }
    },

    "why_it_matters": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "md": { "type": "string" },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "md", "citations"],
        "additionalProperties": false
      }
    },

    "connections": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "items_md": { "type": "array", "items": { "type": "string" } },
          "citations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
            }
          }
        },
        "required": ["id", "title", "items_md", "citations"],
        "additionalProperties": false
      }
    },

	    "quick_checks": {
	      "type": "array",
	      "items": {
	        "type": "object",
	        "properties": {
	          "id": { "type": "string" },
	          "kind": { "type": "string", "enum": ["short_answer", "true_false", "mcq", ""] },
	          "prompt_md": { "type": "string" },
	          "options": {
	            "type": "array",
	            "items": {
	              "type": "object",
	              "properties": {
	                "id": { "type": "string" },
	                "text": { "type": "string" }
	              },
	              "required": ["id", "text"],
	              "additionalProperties": false
	            }
	          },
	          "answer_id": { "type": "string" },
	          "answer_md": { "type": "string" },
	          "citations": {
	            "type": "array",
	            "items": {
	              "type": "object",
              "properties": {
                "chunk_id": { "type": "string" },
                "quote": { "type": "string" },
                "loc": {
                  "type": "object",
                  "properties": {
                    "page": { "type": "integer" },
                    "start": { "type": "integer" },
                    "end": { "type": "integer" }
                  },
                  "required": ["page", "start", "end"],
                  "additionalProperties": false
                }
              },
              "required": ["chunk_id", "quote", "loc"],
              "additionalProperties": false
	            }
	          }
	        },
	        "required": ["id", "kind", "prompt_md", "options", "answer_id", "answer_md", "citations"],
	        "additionalProperties": false
	      }
	    },

	    "flashcards": {
	      "type": "array",
	      "items": {
	        "type": "object",
	        "properties": {
	          "id": { "type": "string" },
	          "front_md": { "type": "string" },
	          "back_md": { "type": "string" },
	          "concept_keys": { "type": "array", "items": { "type": "string" } },
	          "citations": {
	            "type": "array",
	            "items": {
	              "type": "object",
	              "properties": {
	                "chunk_id": { "type": "string" },
	                "quote": { "type": "string" },
	                "loc": {
	                  "type": "object",
	                  "properties": {
	                    "page": { "type": "integer" },
	                    "start": { "type": "integer" },
	                    "end": { "type": "integer" }
	                  },
	                  "required": ["page", "start", "end"],
	                  "additionalProperties": false
	                }
	              },
	              "required": ["chunk_id", "quote", "loc"],
	              "additionalProperties": false
	            }
	          }
	        },
        "required": ["id", "front_md", "back_md", "concept_keys", "citations"],
        "additionalProperties": false
      }
    },

    "dividers": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": { "id": { "type": "string" } },
        "required": ["id"],
        "additionalProperties": false
      }
    }
  },
  "required": [
    "schema_version",
    "title",
    "summary",
    "concept_keys",
    "estimated_minutes",
    "order",
    "headings",
    "paragraphs",
    "callouts",
    "codes",
    "figures",
    "videos",
    "diagrams",
    "tables",
    "equations",
    "objectives",
    "prerequisites",
    "key_takeaways",
    "glossary",
    "common_mistakes",
    "misconceptions",
    "edge_cases",
    "heuristics",
    "steps",
    "checklist",
    "faq",
    "intuition",
    "mental_model",
    "why_it_matters",
    "connections",
    "quick_checks",
    "flashcards",
    "dividers"
  ],
  "additionalProperties": false
}
